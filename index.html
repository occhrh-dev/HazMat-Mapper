<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HazMat Mapper (Mobile)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Sarabun', sans-serif; overflow: hidden; background: #e5e5e5; }
        
        /* üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡∏î */
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }

        /* üîç ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏•‡∏≠‡∏¢ (Floating Search) */
        .search-container {
            position: absolute; top: 15px; left: 15px; right: 15px; z-index: 1000;
            display: flex; background: white; border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 5px 10px;
            align-items: center;
        }
        .search-container input {
            flex: 1; border: none; outline: none; padding: 10px 5px 10px 10px;
            font-size: 1rem; border-radius: 30px; font-family: 'Sarabun', sans-serif;
        }
        .search-container button {
            background: #1a73e8; color: white; border: none; border-radius: 50%;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 2px 5px rgba(26,115,232,0.4);
        }

        /* üìã ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ (Pop-up Card) */
        #chem-info {
            display: none; position: absolute; top: 75px; left: 15px; right: 15px; z-index: 1000;
            background: white; padding: 15px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-left: 5px solid #ff9800;
            animation: slideDown 0.3s ease-out;
        }
        .close-btn { position: absolute; top: 10px; right: 15px; color: #999; font-size: 1.2rem; cursor: pointer; }
        
        /* üìç ‡∏õ‡∏∏‡πà‡∏° GPS ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á */
        .gps-btn {
            position: absolute; bottom: 80px; right: 15px; z-index: 1000;
            background: white; border: 2px solid #ddd; border-radius: 50%;
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; color: #1a73e8; font-size: 1.2rem;
        }

        /* üìè ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î */
        #status-bar {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(44, 62, 80, 0.95); backdrop-filter: blur(5px); color: white;
            padding: 15px 10px; text-align: center; font-size: 0.95rem;
            border-top-left-radius: 15px; border-top-right-radius: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .distance-badge { font-size: 1.3rem; font-weight: bold; color: #f1c40f; }

        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="search-container">
        <input type="text" id="chemInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ UN No. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£...">
        <button onclick="searchChemical()"><i class="fas fa-search"></i></button>
    </div>

    <div id="chem-info">
        <i class="fas fa-times close-btn" onclick="closeInfo()"></i>
        <div id="chem-info-content"></div>
    </div>

    <div class="gps-btn" onclick="locateUser()">
        <i class="fas fa-crosshairs"></i>
    </div>

    <div id="status-bar">
        ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á: <span id="distDisplay" class="distance-badge">-</span> ‡πÄ‡∏°‡∏ï‡∏£
    </div>

    <script src="db.js"></script>

    <script>
        let map, incidentMarker, userMarker, dangerCircle1, dangerCircle2, currentChem = null;

        function initMap() {
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ã‡∏π‡∏°‡∏Ç‡∏≠‡∏á Leaflet (+/-) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏à‡∏µ‡∏ö‡∏ô‡∏¥‡πâ‡∏ß‡∏ã‡∏π‡∏°‡πÄ‡∏≠‡∏≤‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏î‡∏π‡∏Ñ‡∏•‡∏µ‡∏ô‡πÜ
            map = L.map('map', { zoomControl: false }).setView([12.6814, 101.2816], 12); 
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OSM'
            }).addTo(map);
            
            map.on('click', function(e) { setIncidentLocation(e.latlng); });
        }
        initMap();

        function searchChemical() {
            let val = document.getElementById('chemInput').value.trim().toUpperCase();
            if(!val) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤");

            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            let found = ERG_DATABASE.find(c => 
                String(c.mtl_id) === val || 
                (c.name && c.name.toUpperCase().includes(val))
            );

            let infoBox = document.getElementById('chem-info');
            let content = document.getElementById('chem-info-content');
            
            if (found) {
                currentChem = found;
                infoBox.style.display = 'block';
                content.innerHTML = `
                    <div style="color:#e65100; font-weight:bold; font-size:1.1rem; margin-bottom:5px;">
                        <i class="fas fa-biohazard"></i> ${found.name}
                    </div>
                    <div style="font-size:0.9rem; color:#555; margin-bottom:8px;">
                        <b>UN:</b> ${found.mtl_id} | <b>Guide:</b> ${found.guide_num}
                    </div>
                    <div style="background:#fff3e0; padding:8px; border-radius:8px; font-size:0.85rem; color:#d84315;">
                        <b>üî¥ ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Å‡∏±‡πâ‡∏ô‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:</b><br>
                        ‚Ä¢ ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÄ‡∏•‡πá‡∏Å: <b>${found.sm_iso || 30}</b> ‡∏°.<br>
                        ‚Ä¢ ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÉ‡∏´‡∏ç‡πà: <b>${found.lg_iso || 100}</b> ‡∏°.<br>
                        ‚Ä¢ ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ: <b>${found.fire_iso || 800}</b> ‡∏°.
                    </div>
                    <div style="margin-top:10px; font-size:0.75rem; color:#888; text-align:center;">
                        <i class="fas fa-hand-pointer"></i> ‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏
                    </div>
                `;
                
                // ‡∏ñ‡∏≠‡∏¢‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏•‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à (UX ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
                document.getElementById('chemInput').blur();

                if (incidentMarker) drawSafetyZones(incidentMarker.getLatLng());

            } else {
                infoBox.style.display = 'none';
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô 1017 ‡∏´‡∏£‡∏∑‡∏≠ CHLORINE)");
            }
        }

        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î
        function closeInfo() {
            document.getElementById('chem-info').style.display = 'none';
        }

        function setIncidentLocation(latlng) {
            if (!currentChem) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏ï‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡∏ö");
            
            if (incidentMarker) map.removeLayer(incidentMarker);
            
            var redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            incidentMarker = L.marker(latlng, {icon: redIcon}).addTo(map)
                .bindPopup(`<b>üî• ${currentChem.name}</b>`).openPopup();
            
            drawSafetyZones(latlng);
            calculateDistance();
            
            // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            closeInfo();
        }

        function drawSafetyZones(latlng) {
            if (dangerCircle1) map.removeLayer(dangerCircle1);
            if (dangerCircle2) map.removeLayer(dangerCircle2);
            
            let rSmall = currentChem.sm_iso || 30;
            let rLarge = currentChem.lg_iso || 100;

            // ‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏Å (‡πÅ‡∏î‡∏á)
            dangerCircle1 = L.circle(latlng, { color: '#e74c3c', fillColor: '#e74c3c', fillOpacity: 0.4, radius: rSmall }).addTo(map);
            // ‡∏ß‡∏á‡πÉ‡∏´‡∏ç‡πà (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á)
            dangerCircle2 = L.circle(latlng, { color: '#f1c40f', fillColor: '#f1c40f', fillOpacity: 0.15, radius: rLarge }).addTo(map);
            
            // ‡∏Ç‡∏¢‡∏±‡∏ö‡∏à‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏ß‡∏á‡∏Å‡∏•‡∏°
            map.fitBounds(dangerCircle2.getBounds(), { padding: [50, 50] });
        }

        function locateUser() { 
            // ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î
            let btn = document.querySelector('.gps-btn i');
            btn.classList.add('fa-spin', 'fa-spinner');
            btn.classList.remove('fa-crosshairs');
            
            map.locate({setView: true, maxZoom: 16}); 
        }

        map.on('locationfound', function(e) {
            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°
            let btn = document.querySelector('.gps-btn i');
            btn.classList.remove('fa-spin', 'fa-spinner');
            btn.classList.add('fa-crosshairs');

            if (userMarker) map.removeLayer(userMarker);
            
            var blueIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            userMarker = L.marker(e.latlng, {icon: blueIcon}).addTo(map).bindPopup("üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì").openPopup();
            calculateDistance();
        });

        map.on('locationerror', function(e){ 
            let btn = document.querySelector('.gps-btn i');
            btn.classList.remove('fa-spin', 'fa-spinner');
            btn.classList.add('fa-crosshairs');
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡∏ó‡∏µ‡πà‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö"); 
        });
        
        function calculateDistance() {
            if (incidentMarker && userMarker) {
                let dist = map.distance(incidentMarker.getLatLng(), userMarker.getLatLng());
                let el = document.getElementById('distDisplay');
                el.innerText = Math.round(dist).toLocaleString();
                
                let rSmall = currentChem.sm_iso || 30;
                let rLarge = currentChem.lg_iso || 100;

                if (dist < rSmall) {
                    el.style.color = "#ff4d4d"; el.innerHTML += " <br><span style='font-size:0.8rem;'>(‚õî ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏Å‡∏±‡πâ‡∏ô)</span>";
                } else if (dist < rLarge) {
                    el.style.color = "#f39c12"; el.innerHTML += " <br><span style='font-size:0.8rem;'>(‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á! ‡∏≠‡∏≤‡∏à‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö)</span>";
                } else {
                    el.style.color = "#2ecc71"; el.innerHTML += " <br><span style='font-size:0.8rem;'>(‚úÖ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)</span>";
                }
            }
        }
    </script>
</body>
</html>

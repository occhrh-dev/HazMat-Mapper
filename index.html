<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HazMat Mapper (Operational UI)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Sarabun', sans-serif; overflow: hidden; background: #e5e5e5; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }

        /* üîç ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */
        .search-container {
            position: absolute; top: 15px; left: 15px; right: 15px; z-index: 1000;
            display: flex; background: white; border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 5px 10px; align-items: center;
        }
        .search-container input {
            flex: 1; border: none; outline: none; padding: 10px 5px 10px 10px;
            font-size: 1rem; border-radius: 30px; font-family: 'Sarabun', sans-serif;
        }
        .search-container button {
            background: #1a73e8; color: white; border: none; border-radius: 50%;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* üîΩ Dropdown */
        .suggestions-box {
            display: none; position: absolute; top: 65px; left: 20px; right: 20px; z-index: 999;
            background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-height: 250px; overflow-y: auto;
        }
        .suggestion-item { padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 0.95rem; cursor: pointer; display: flex; align-items: flex-start; gap: 10px; }

        /* üìã ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô Map ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß) */
        #chem-info {
            display: none; position: absolute; top: 75px; left: 15px; right: 15px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 15px; backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-left: 5px solid #ff9800; max-height: 50vh; overflow-y: auto;
        }
        .close-btn { position: absolute; top: 10px; right: 15px; color: #999; font-size: 1.2rem; cursor: pointer; padding: 5px; }
        
        /* üìç ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á */
        .float-btn-group { position: absolute; bottom: 85px; right: 15px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .action-btn {
            background: white; border: 2px solid #ddd; border-radius: 50%; width: 45px; height: 45px;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; color: #1a73e8; font-size: 1.1rem;
        }
        .action-btn.satellite { color: #27ae60; }

        /* üìè ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
        #status-bar {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000; background: rgba(44, 62, 80, 0.95);
            color: white; padding: 15px 10px; text-align: center; font-size: 0.95rem; border-top-left-radius: 15px; border-top-right-radius: 15px;
        }
        .distance-badge { font-size: 1.3rem; font-weight: bold; color: #f1c40f; }

        /* ========================================= */
        /* üé® Custom Labels ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏•‡∏≠‡∏¢‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ Map) */
        /* ========================================= */
        
        /* ‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ */
        .chem-marker-label {
            background: #fff; border: 2px solid #e74c3c; border-radius: 8px; color: #c0392b;
            font-family: 'Sarabun', sans-serif; font-weight: bold; font-size: 13px;
            padding: 2px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); text-align: center;
        }
        
        /* ‡∏õ‡πâ‡∏≤‡∏¢‡∏ö‡∏≠‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏° */
        .wind-text-label {
            background: transparent; border: none; box-shadow: none; color: #008b8b;
            font-family: 'Sarabun', sans-serif; font-weight: bold; font-size: 13px;
            text-shadow: -1px -1px 2px #fff, 1px -1px 2px #fff, -1px 1px 2px #fff, 1px 1px 2px #fff;
            text-align: center; line-height: 1.2;
        }

        /* ‡∏õ‡πâ‡∏≤‡∏¢‡∏ö‡∏≠‡∏Å‡∏à‡∏∏‡∏î Command Post */
        .cp-text-label {
            background: transparent; border: none; box-shadow: none; color: #1e8449;
            font-family: 'Sarabun', sans-serif; font-weight: bold; font-size: 13px;
            text-shadow: -1px -1px 2px #fff, 1px -1px 2px #fff, -1px 1px 2px #fff, 1px 1px 2px #fff;
            text-align: center; line-height: 1.2;
        }

        .clear-div-icon { background: transparent; border: none; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="search-container">
        <input type="text" id="chemInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ UN No. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£..." oninput="showSuggestions()" autocomplete="off">
        <button onclick="searchChemical()"><i class="fas fa-search"></i></button>
    </div>

    <div id="suggestionsBox" class="suggestions-box"></div>

    <div id="chem-info">
        <i class="fas fa-times close-btn" onclick="closeInfo()"></i>
        <div id="chem-info-content"></div>
    </div>

    <div class="float-btn-group">
        <div class="action-btn satellite" onclick="toggleMapLayer()" id="btnLayer"><i class="fas fa-satellite"></i></div>
        <div class="action-btn gps-btn" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>
    </div>

    <div id="status-bar">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á: <span id="distDisplay" class="distance-badge">-</span> ‡πÄ‡∏°‡∏ï‡∏£</div>

    <script src="db.js"></script>

    <script>
        let map, incidentMarker, userMarker, dangerCircle1, dangerCircle2, currentChem = null;
        let windLine, windArrow, windTextMarker; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏•‡∏°
        let cpPolygon, cpTextMarker;             // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î Command Post
        
        let osmLayer, satLayer;
        let isSatellite = false;

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([12.6814, 101.2816], 12); 
            osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
            
            map.on('click', function(e) { 
                document.getElementById('suggestionsBox').style.display = 'none';
                setIncidentLocation(e.latlng); 
            });
        }
        initMap();

        function toggleMapLayer() {
            let btnIcon = document.querySelector('#btnLayer i');
            if (isSatellite) {
                map.removeLayer(satLayer); osmLayer.addTo(map);
                isSatellite = false; btnIcon.className = "fas fa-satellite";
            } else {
                map.removeLayer(osmLayer); satLayer.addTo(map);
                isSatellite = true; btnIcon.className = "fas fa-map";
            }
        }

        function showSuggestions() {
            let val = document.getElementById('chemInput').value.trim().toUpperCase();
            let box = document.getElementById('suggestionsBox');
            if(val.length < 2) { box.style.display = 'none'; return; }

            let matches = ERG_DATABASE.filter(c => String(c.mtl_id).includes(val) || (c.name && c.name.toUpperCase().includes(val))).slice(0, 15);
            if(matches.length > 0) {
                box.innerHTML = matches.map(m => `<div class="suggestion-item" onclick="selectSuggestion('${m.mtl_id}')"><i class="fas fa-flask"></i> <div><span style="color:#1a73e8; font-weight:bold;">${m.mtl_id}</span> - <span style="color:#555;">${m.name}</span></div></div>`).join('');
                box.style.display = 'block';
            } else {
                box.innerHTML = `<div class="suggestion-item" style="color:#aaa; justify-content:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
                box.style.display = 'block';
            }
        }

        function selectSuggestion(unNo) {
            document.getElementById('chemInput').value = unNo;
            document.getElementById('suggestionsBox').style.display = 'none';
            searchChemical();
        }

        function searchChemical() {
            let val = document.getElementById('chemInput').value.trim().toUpperCase();
            if(!val) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            document.getElementById('suggestionsBox').style.display = 'none';

            let found = ERG_DATABASE.find(c => String(c.mtl_id) === val || (c.name && c.name.toUpperCase() === val));
            if(!found) found = ERG_DATABASE.find(c => c.name && c.name.toUpperCase().includes(val));

            let infoBox = document.getElementById('chem-info');
            let content = document.getElementById('chem-info-content');
            
            if (found) {
                currentChem = found;
                infoBox.style.display = 'block';
                // ‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏°‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πå‡∏î ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡∏ô
                content.innerHTML = `
                    <div style="color:#e65100; font-weight:bold; font-size:1.1rem; margin-bottom:5px;">
                        <i class="fas fa-biohazard"></i> ${found.name}
                    </div>
                    <div style="font-size:0.85rem; color:#555; margin-bottom:8px;"><b>UN:</b> ${found.mtl_id} | <b>Guide:</b> ${found.guide_num}</div>
                    <div style="margin-top:5px; font-size:0.8rem; color:#1a73e8; text-align:center;">
                        <i class="fas fa-hand-pointer"></i> ‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏
                    </div>
                `;
                
                document.getElementById('chemInput').blur();
                if (incidentMarker) setIncidentLocation(incidentMarker.getLatLng());

            } else {
                infoBox.style.display = 'none'; alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            }
        }

        function closeInfo() { document.getElementById('chem-info').style.display = 'none'; }

        // ==========================================
        // üó∫Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        // ==========================================
        function setIncidentLocation(latlng) {
            if (!currentChem) return; 
            
            if (incidentMarker) map.removeLayer(incidentMarker);
            
            var redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41]
            });

            // üåü 1. ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏ä‡∏ß‡πå "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ" ‡∏•‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
            incidentMarker = L.marker(latlng, {icon: redIcon}).addTo(map)
                .bindTooltip(`<b>UN: ${currentChem.mtl_id}</b><br>${currentChem.name}`, {
                    permanent: true, direction: 'top', offset: [0, -35], className: 'chem-marker-label'
                }).openTooltip();
            
            drawSafetyZones(latlng);
            calculateDistance();
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠
            fetchWindAndDrawOnMap(latlng.lat, latlng.lng);
            closeInfo(); // ‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏¢ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÜ
        }

        function drawSafetyZones(latlng) {
            if (dangerCircle1) map.removeLayer(dangerCircle1);
            if (dangerCircle2) map.removeLayer(dangerCircle2);
            
            let rSmall = currentChem.sm_iso || 30;
            let rLarge = currentChem.lg_iso || 100;

            dangerCircle1 = L.circle(latlng, { color: '#c0392b', fillColor: '#e74c3c', fillOpacity: 0.4, radius: rSmall }).addTo(map);
            dangerCircle2 = L.circle(latlng, { color: '#f39c12', fillColor: '#f1c40f', fillOpacity: 0.15, radius: rLarge }).addTo(map);
        }

        // üåü 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏°‡πÅ‡∏•‡∏∞ CP ‡∏•‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        async function fetchWindAndDrawOnMap(lat, lng) {
            try {
                let res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=wind_speed_10m,wind_direction_10m`);
                let data = await res.json();
                let windSpeed = data.current.wind_speed_10m; 
                let windDir = data.current.wind_direction_10m;

                let upwindAngle = windDir; // ‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡∏•‡∏°‡∏°‡∏≤ (‡∏ó‡∏¥‡∏®‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏•‡∏°) -> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á CP
                let downwindAngle = (windDir + 180) % 360; // ‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡∏•‡∏°‡πÑ‡∏õ (‡∏ó‡∏¥‡∏®‡πÉ‡∏ï‡πâ‡∏•‡∏°) -> ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏©
                let downwindText = getSimpleCompass(downwindAngle); 

                // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£ ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏°
                drawWindArrowAndText(lat, lng, downwindAngle, downwindText, windSpeed);
                
                // ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏£‡πÄ‡∏á‡∏≤‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Command Post
                drawCommandPostZone(lat, lng, upwindAngle);

            } catch (e) {
                console.log("Wind fetch error");
            }
        }

        function drawWindArrowAndText(lat, lng, angle, dirText, speed) {
            if(windLine) map.removeLayer(windLine);
            if(windArrow) map.removeLayer(windArrow);
            if(windTextMarker) map.removeLayer(windTextMarker);

            let rLarge = currentChem.lg_iso || 100;
            let distanceMeters = Math.max(rLarge * 1.5, 400); 

            let rad = angle * Math.PI / 180;
            let deltaLat = (distanceMeters * Math.cos(rad)) / 111320;
            let deltaLng = (distanceMeters * Math.sin(rad)) / (111320 * Math.cos(lat * Math.PI / 180));
            let endLatLng = [lat + deltaLat, lng + deltaLng];

            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏° (‡∏™‡∏µ‡∏ü‡πâ‡∏≤)
            windLine = L.polyline([[lat, lng], endLatLng], { color: '#00d2ff', weight: 4, dashArray: '8, 8' }).addTo(map);

            // ‡∏ß‡∏≤‡∏î‡∏´‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏®‡∏£
            let arrowIcon = L.divIcon({
                className: 'clear-div-icon',
                html: `<div style="transform: rotate(${angle}deg); color: #00d2ff; font-size: 22px; text-shadow: 0px 0px 2px rgba(0,0,0,0.8); margin-top:-10px; margin-left:-4px;"><i class="fas fa-arrow-up"></i></div>`,
                iconSize: [20, 20]
            });
            windArrow = L.marker(endLatLng, {icon: arrowIcon}).addTo(map);

            // üåü 3. ‡πÅ‡∏õ‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡πÜ ‡∏•‡∏π‡∏Å‡∏®‡∏£
            let textLatLng = [lat + (deltaLat * 1.1), lng + (deltaLng * 1.1)];
            windTextMarker = L.marker(textLatLng, {
                icon: L.divIcon({
                    className: 'wind-text-label',
                    html: `‡∏ó‡∏¥‡∏® ${dirText}<br>${speed} km/h`,
                    iconSize: [120, 40], iconAnchor: [60, 20]
                })
            }).addTo(map);
        }

        // üåü 4. ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà Command Post (CP) ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ã‡∏ô‡πÅ‡∏£‡πÄ‡∏á‡∏≤‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏•‡∏°
        function drawCommandPostZone(lat, lng, upwindAngle) {
            if(cpPolygon) map.removeLayer(cpPolygon);
            if(cpTextMarker) map.removeLayer(cpTextMarker);

            let rLarge = currentChem.lg_iso || 100;
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)
            let startDist = rLarge + 150; 
            let endDist = Math.max(startDist + 300, 700);

            let points = [];
            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏Å‡∏£‡∏ß‡∏¢ (Wedge) ‡∏Å‡∏≤‡∏á‡∏≠‡∏≠‡∏Å 60 ‡∏≠‡∏á‡∏®‡∏≤ (-30 ‡∏ñ‡∏∂‡∏á +30)
            for(let i = -30; i <= 30; i += 10) {
                points.push(getDestination(lat, lng, endDist, upwindAngle + i));
            }
            for(let i = 30; i >= -30; i -= 10) {
                points.push(getDestination(lat, lng, startDist, upwindAngle + i));
            }

            // ‡∏ß‡∏≤‡∏î Polygon ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
            cpPolygon = L.polygon(points, {
                color: '#27ae60', fillColor: '#2ecc71', fillOpacity: 0.35, weight: 2, dashArray: '5, 5'
            }).addTo(map);

            // ‡πÅ‡∏õ‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Command Post ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÇ‡∏ã‡∏ô
            let cpCenter = getDestination(lat, lng, startDist + 150, upwindAngle);
            cpTextMarker = L.marker(cpCenter, {
                icon: L.divIcon({
                    className: 'cp-text-label',
                    html: `<i class="fas fa-shield-alt"></i> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á CP<br>(‡∏ó‡∏¥‡∏®‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏•‡∏°)`,
                    iconSize: [120, 40], iconAnchor: [60, 20]
                })
            }).addTo(map);
            
            // ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á CP ‡πÅ‡∏•‡∏∞ ‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏•‡∏°
            map.fitBounds(L.featureGroup([dangerCircle2, cpPolygon, windLine]).getBounds(), { padding: [50, 50] });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏≠‡∏á‡∏®‡∏≤
        function getDestination(lat, lng, dist, bearing) {
            let rad = bearing * Math.PI / 180;
            let deltaLat = (dist * Math.cos(rad)) / 111320;
            let deltaLng = (dist * Math.sin(rad)) / (111320 * Math.cos(lat * Math.PI / 180));
            return [lat + deltaLat, lng + deltaLng];
        }

        function getSimpleCompass(deg) {
            const val = Math.floor((deg / 45) + 0.5);
            const arr = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
            return arr[(val % 8)];
        }

        // ==========================================
        // üìç ‡∏£‡∏∞‡∏ö‡∏ö GPS 
        // ==========================================
        function locateUser() { 
            let btn = document.querySelector('.gps-btn i');
            btn.className = "fas fa-spinner fa-spin";
            map.locate({setView: true, maxZoom: 16}); 
        }

        map.on('locationfound', function(e) {
            let btn = document.querySelector('.gps-btn i');
            btn.className = "fas fa-crosshairs";

            if (userMarker) map.removeLayer(userMarker);
            
            var blueIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41]
            });

            userMarker = L.marker(e.latlng, {icon: blueIcon}).addTo(map).bindPopup("üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì").openPopup();
            calculateDistance();
        });
        
        function calculateDistance() {
            if (incidentMarker && userMarker) {
                let dist = map.distance(incidentMarker.getLatLng(), userMarker.getLatLng());
                let el = document.getElementById('distDisplay');
                el.innerText = Math.round(dist).toLocaleString();
                
                let rSmall = currentChem.sm_iso || 30; let rLarge = currentChem.lg_iso || 100;

                if (dist < rSmall) { el.style.color = "#ff4d4d"; el.innerHTML += " <span style='font-size:0.8rem;'>(‚õî ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏Å‡∏±‡πâ‡∏ô)</span>"; } 
                else if (dist < rLarge) { el.style.color = "#f39c12"; el.innerHTML += " <span style='font-size:0.8rem;'>(‚ö†Ô∏è ‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á)</span>"; } 
                else { el.style.color = "#2ecc71"; el.innerHTML += " <span style='font-size:0.8rem;'>(‚úÖ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)</span>"; }
            }
        }
    </script>
</body>
</html>

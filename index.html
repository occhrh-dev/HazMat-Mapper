<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HazMat Mapper</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin:0; padding:0; font-family: 'Sarabun', sans-serif; display:flex; flex-direction:column; height:100vh; }
        #map { flex: 1; z-index: 1; }
        #control-panel { background: white; padding: 15px; border-bottom: 2px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 2; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-search { background: #1a73e8; }
        .btn-gps { background: #2ecc71; width: 100%; margin-top: 5px; }
        #chem-info { display: none; background: #fff3e0; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #ffb74d; color: #e65100; }
        #status-bar { background: #2c3e50; color: white; padding: 10px; text-align: center; font-size: 0.9rem; z-index: 2; }
        .distance-badge { font-size: 1.2rem; font-weight: bold; color: #f1c40f; }
    </style>
</head>
<body>

    <div id="control-panel">
        <h3 style="margin:0 0 10px 0;">‚ò£Ô∏è ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏†‡∏±‡∏¢‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ (Offline)</h3>
        <div class="input-group">
            <input type="text" id="chemInput" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ UN No. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô 1017)">
            <button class="btn-search" onclick="searchChemical()"><i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>
        <div id="chem-info"></div>
        <button class="btn-gps" onclick="locateUser()"><i class="fas fa-crosshairs"></i> ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</button>
    </div>

    <div id="map"></div>
    <div id="status-bar">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏: <span id="distDisplay" class="distance-badge">-</span> ‡πÄ‡∏°‡∏ï‡∏£</div>

    <script src="db.js"></script>

    <script>
        let map, incidentMarker, userMarker, dangerCircle1, dangerCircle2, currentChem = null;

        function initMap() {
            map = L.map('map').setView([12.6814, 101.2816], 12); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏¢‡∏≠‡∏á
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            map.on('click', function(e) { setIncidentLocation(e.latlng); });
        }
        initMap();

        function searchChemical() {
            let val = document.getElementById('chemInput').value.trim().toUpperCase();
            if(!val) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");

            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô ERG_DATABASE
            let found = ERG_DATABASE.find(c => 
                String(c.un) === val || 
                (c.name && c.name.toUpperCase().includes(val))
            );

            let infoBox = document.getElementById('chem-info');
            
            if (found) {
                currentChem = found;
                infoBox.style.display = 'block';
                infoBox.innerHTML = `
                    <b>‚úÖ ‡∏û‡∏ö‡∏™‡∏≤‡∏£:</b> ${found.name} <br>
                    <b>üÜî UN:</b> ${found.un} (Guide: ${found.guide})<br>
                    <hr style="margin:5px 0; border:0; border-top:1px dashed #e65100;">
                    <b>üî¥ ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Å‡∏±‡πâ‡∏ô‡πÄ‡∏Ç‡∏ï (Isolation):</b><br>
                    - ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÄ‡∏•‡πá‡∏Å: <b>${found.iso_small || 30}</b> ‡∏°.<br>
                    - ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÉ‡∏´‡∏ç‡πà: <b>${found.iso_large || 100}</b> ‡∏°.<br>
                    - ‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ: <b>${found.fire_iso || 800}</b> ‡∏°.<br>
                    <small style="color:#d84315;">*‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</small>
                `;
                if (incidentMarker) drawSafetyZones(incidentMarker.getLatLng());
            } else {
                infoBox.style.display = 'none';
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏•‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô 1017 ‡∏´‡∏£‡∏∑‡∏≠ CHLORINE)");
            }
        }

        function setIncidentLocation(latlng) {
            if (!currentChem) return alert("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
            if (incidentMarker) map.removeLayer(incidentMarker);
            
            var redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            incidentMarker = L.marker(latlng, {icon: redIcon}).addTo(map)
                .bindPopup(`<b>üî• ${currentChem.name}</b>`).openPopup();
            drawSafetyZones(latlng);
            calculateDistance();
        }

        function drawSafetyZones(latlng) {
            if (dangerCircle1) map.removeLayer(dangerCircle1);
            if (dangerCircle2) map.removeLayer(dangerCircle2);
            
            let rSmall = currentChem.iso_small || 30;
            let rLarge = currentChem.iso_large || 100;

            dangerCircle1 = L.circle(latlng, { color: 'red', fillColor: '#f03', fillOpacity: 0.5, radius: rSmall }).addTo(map);
            dangerCircle2 = L.circle(latlng, { color: 'orange', fillColor: '#f39c12', fillOpacity: 0.2, radius: rLarge }).addTo(map);
            map.fitBounds(dangerCircle2.getBounds());
        }

        function locateUser() { map.locate({setView: true, maxZoom: 16}); }
        map.on('locationfound', function(e) {
            if (userMarker) map.removeLayer(userMarker);
            
            var blueIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            userMarker = L.marker(e.latlng, {icon: blueIcon}).addTo(map).bindPopup("üìç ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà").openPopup();
            calculateDistance();
        });
        map.on('locationerror', function(e){ alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS"); });
        
        function calculateDistance() {
            if (incidentMarker && userMarker) {
                let dist = map.distance(incidentMarker.getLatLng(), userMarker.getLatLng());
                let el = document.getElementById('distDisplay');
                el.innerText = Math.round(dist).toLocaleString();
                
                if (dist < currentChem.iso_small) {
                    el.style.color = "#ff0000"; el.innerHTML += " (‚õî ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢!)";
                } else if (dist < currentChem.iso_large) {
                    el.style.color = "#e67e22"; el.innerHTML += " (‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á)";
                } else {
                    el.style.color = "#2ecc71"; el.innerHTML += " (‚úÖ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)";
                }
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏à‡∏∏‡∏î‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a73e8">
    <link rel="apple-touch-icon" href="icon-512.png">

    <style>
        /* ========================================= */
        /* 1. Base & Layout                          */
        /* ========================================= */
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Sarabun', sans-serif; overflow: hidden; background: #e5e5e5; }
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }

        /* ========================================= */
        /* 2. Search & Banner (Top UI)               */
        /* ========================================= */
        .search-container { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 1000; display: flex; background: white; border-radius: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 5px 10px; align-items: center; }
        .search-container input { flex: 1; border: none; outline: none; padding: 10px 5px 10px 10px; font-size: 1rem; border-radius: 30px; font-family: 'Sarabun', sans-serif; }
        .search-container button { background: #1a73e8; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .suggestions-box { display: none; position: absolute; top: 65px; left: 20px; right: 20px; z-index: 999; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-height: 250px; overflow-y: auto; }
        .suggestion-item { padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 0.95rem; cursor: pointer; display: flex; align-items: flex-start; gap: 10px; }

        #chem-banner { display: none; position: absolute; top: 65px; left: 15px; right: 15px; z-index: 999; background: rgba(255, 255, 255, 0.95); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); padding: 8px 12px; cursor: pointer; border-left: 6px solid #e74c3c; backdrop-filter: blur(5px); transition: 0.2s; }
        #chem-banner:active { transform: scale(0.98); }
        .chem-banner-content { display: flex; align-items: center; gap: 15px; }
        #banner-name { font-size: 1rem !important; }

        /* ========================================= */
        /* 3. Detail Card                            */
        /* ========================================= */
        #detail-card { display: none; position: absolute; top: 75px; left: 15px; right: 15px; z-index: 1000; background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); border-top: 6px solid #ff9800; padding: 15px; }
        .detail-header { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
        .detail-title { flex: 1; font-weight: bold; color: #e65100; font-size: 1.2rem; }
        .detail-un { font-size: 0.9rem; color: #666; margin-bottom: 10px; }
        .detail-zone-box { background: #fff8e1; border-radius: 10px; padding: 10px; border: 1px dashed #ffb74d; }
        .zone-title { font-weight: bold; color: #d84315; margin-bottom: 5px; }
        .zone-item { font-size: 0.9rem; margin-bottom: 3px; }

        /* ========================================= */
        /* 4. Action Buttons (Bottom Right)          */
        /* ========================================= */
        .float-btn-group { position: absolute; bottom: 75px; right: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; align-items: center;}
        #scenario-selector { display: none; flex-direction: column; gap: 8px; margin-bottom: 5px; border-bottom: 2px solid #ccc; padding-bottom: 10px; }
        
        /* ‡∏¢‡∏∏‡∏ö‡∏£‡∏ß‡∏° CSS ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ‡πÅ‡∏•‡∏∞‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (38px) */
        .scenario-fab, .action-btn { background: white; border: 2px solid #ddd; border-radius: 50%; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; position: relative; }
        
        .scenario-fab { font-size: 0.9rem; font-weight: bold; color: #95a5a6; }
        #btn-fire i { font-size: 1.1rem; }
        .scenario-fab.active-fire { background: #d35400; color: white; border-color: #c0392b; }
        .scenario-fab.active-large { background: #f39c12; color: white; border-color: #e67e22; }
        .scenario-fab.active-small { background: #e74c3c; color: white; border-color: #c0392b; }
        
        .action-btn { color: #1a73e8; font-size: 1rem; }
        .action-btn.satellite { color: #27ae60; }

        /* ========================================= */
        /* 5. Status Bar (Bottom)                    */
        /* ========================================= */
        #status-bar { position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000; background: rgba(44, 62, 80, 0.95); color: white; padding: 15px 10px; text-align: center; font-size: 0.95rem; border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .distance-badge { font-size: 1.3rem; font-weight: bold; color: #f1c40f; }

        /* ========================================= */
        /* 6. Map Labels & Icons                     */
        /* ========================================= */
        .clear-div-icon { background: transparent; border: none; }
        .leaflet-tooltip-top:before, .leaflet-tooltip-bottom:before, .leaflet-tooltip-left:before, .leaflet-tooltip-right:before { border: none !important; }

        .user-location-label { background-color: #27ae60; color: white; border: 1px solid #fff; border-radius: 4px; padding: 1px 4px; font-size: 10px; font-weight: bold; }
        
        .incident-icon-wrapper { background-color: #c0392b; color: white; border: 2px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 0 10px rgba(192, 57, 43, 0.8); animation: pulse-danger 1.5s infinite; }
        @keyframes pulse-danger { 0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(192, 57, 43, 0); } 100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); } }
        .incident-mini-label { background: #c0392b; border: 1px solid #fff; border-radius: 4px; color: #fff; font-family: 'Sarabun', sans-serif; font-weight: bold; font-size: 10px; padding: 1px 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        .cp-text-label { background: #1b5e20 !important; border: 1px solid #fff !important; border-radius: 20px !important; color: #fff !important; font-weight: bold !important; font-size: 11px !important; padding: 3px 10px !important; box-shadow: 0 2px 5px rgba(0,0,0,0.2); white-space: nowrap !important; display: flex; align-items: center; justify-content: center; gap: 6px; }

        .wind-badge { background: #3498db; color: white; padding: 4px 12px; border-radius: 20px; font-family: 'Sarabun', sans-serif; font-weight: bold; font-size: 11px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 2px solid white; display: inline-flex; align-items: center; justify-content: center; white-space: nowrap; }

        .landmark-icon { background: #fff; border: 2px solid #34495e; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .landmark-label { background: rgba(255, 255, 255, 0.9); border: 1px solid #bdc3c7; border-radius: 4px; font-family: 'Sarabun', sans-serif; font-size: 10px; font-weight: bold; color: #2c3e50; padding: 2px 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap; }

        /* ========================================= */
        /* 7. Wind Modal                             */
        /* ========================================= */
        #wind-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .wind-modal-box { background: white; width: 92%; max-width: 380px; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); font-family: 'Sarabun', sans-serif; text-align: center; border-top: 6px solid #3498db; }
        .wind-modal-box h3 { margin: 0 0 5px 0; color: #2c3e50; font-size: 1.25rem; }
        .wind-modal-box p { font-size: 0.9rem; color: #c0392b; margin-bottom: 15px; font-weight: bold; }
        .speed-display { font-size: 0.9rem; color: #7f8c8d; margin-bottom: 15px; background: #f8f9fa; padding: 8px; border-radius: 8px; border: 1px solid #ddd;}
        .compass-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .dir-btn { background: #f1f2f6; border: 2px solid #dfe4ea; border-radius: 12px; padding: 15px 5px; font-family: 'Sarabun', sans-serif; font-weight: bold; color: #576574; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .dir-btn i { font-size: 1.2rem; }
        .dir-btn span { font-size: 0.75rem; line-height: 1; }
        .dir-btn.selected { background: #e8f0fe; border-color: #1a73e8; color: #1a73e8; box-shadow: 0 4px 10px rgba(26,115,232,0.3); transform: scale(1.05); }
        .compass-center { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #bdc3c7; font-size: 2rem; }
        .btn-confirm-wind { background: #2ecc71; color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-size: 1.1rem; font-weight: bold; font-family: 'Sarabun', sans-serif; cursor: pointer; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); transition: 0.2s; margin-top: 10px; }
        .btn-confirm-wind:active { transform: scale(0.95); }

        /* ========================================= */
        /* 8. Semantic Zoom (Hide elements on zoom out) */
        /* ========================================= */
        /* üåü ‡πÉ‡∏´‡πâ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞ "‡∏õ‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°" ‡πÅ‡∏ï‡πà‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡πÑ‡∏ß‡πâ */
        .zoom-out-mode .leaflet-tooltip, 
        .zoom-out-mode .cp-text-label,   
        .zoom-out-mode .wind-badge { 
            opacity: 0 !important; 
            pointer-events: none; 
            transition: opacity 0.3s ease; 
        }
        /* ========================================= */
        /* 9. Tutorial Modal                         */
        /* ========================================= */
        #tutorial-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 99999; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .tutorial-box { background: white; width: 85%; max-width: 400px; border-radius: 20px; padding: 25px 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-family: 'Sarabun', sans-serif; animation: slideDown 0.4s ease-out; }
        .tutorial-box h2 { margin: 0 0 5px 0; color: #2c3e50; font-size: 1.25rem; text-align: center; }
        .tutorial-box p { font-size: 0.85rem; color: #7f8c8d; text-align: center; margin-bottom: 20px; }
        .tutorial-step { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; background: #f8f9fa; padding: 10px 15px; border-radius: 12px; border-left: 4px solid #3498db; }
        .step-icon { background: #e8f0fe; color: #1a73e8; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .step-text { font-size: 0.85rem; color: #34495e; line-height: 1.3; }
        .btn-start-app { background: #1a73e8; color: white; border: none; padding: 12px; width: 100%; border-radius: 12px; font-size: 1.1rem; font-weight: bold; font-family: 'Sarabun', sans-serif; cursor: pointer; box-shadow: 0 4px 10px rgba(26,115,232,0.4); margin-top: 10px; transition: 0.2s; }
        .btn-start-app:active { transform: scale(0.95); }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="tutorial-overlay" style="display: none;">
        <div class="tutorial-box">
            <h2><i class="fas fa-shield-alt" style="color:#27ae60;"></i> ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</h2>
            <p>‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô "‡∏à‡∏∏‡∏î‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢" - ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</p>
            
            <div class="tutorial-step">
                <div class="step-icon"><i class="fas fa-search"></i></div>
                <div class="step-text"><b>1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ</b><br>‡∏û‡∏¥‡∏°‡∏û‡πå UN Number ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>
            </div>
            <div class="tutorial-step">
                <div class="step-icon"><i class="fas fa-map-marker-alt"></i></div>
                <div class="step-text"><b>2. ‡∏õ‡∏±‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</b><br>‡πÅ‡∏ï‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏á‡∏´‡∏°‡∏∏‡∏î ‡πÅ‡∏•‡∏∞ "‡πÅ‡∏ï‡∏∞‡∏Ñ‡πâ‡∏≤‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏≤‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏∏‡∏î</div>
            </div>
            <div class="tutorial-step">
                <div class="step-icon"><i class="fas fa-wind"></i></div>
                <div class="step-text"><b>3. ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏°</b><br>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏°‡∏û‡∏±‡∏î‡πÑ‡∏õ</div>
            </div>
            <div class="tutorial-step">
                <div class="step-icon"><i class="fas fa-running"></i></div>
                <div class="step-text"><b>4. ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏û‡∏¢‡∏û</b><br>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ß‡∏≤‡∏î‡πÄ‡∏Ç‡∏ï‡∏Å‡∏±‡πâ‡∏ô‡∏†‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á CP ‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</div>
            </div>
            
            <button class="btn-start-app" onclick="closeTutorial()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô</button>
        </div>
    </div>
    <div id="detail-card">
        <i class="fas fa-times" style="float: right; color: #999; cursor: pointer;" onclick="closeDetailCard()"></i>
        <div class="detail-header">
            <i class="fas fa-biohazard" style="font-size: 1.5rem; color: #e65100;"></i>
            <div class="detail-title" id="card-name">-</div>
        </div>
        <div class="detail-un" id="card-un">-</div>
        <div class="detail-zone-box">
            <div class="zone-title">üî¥ ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Å‡∏±‡πâ‡∏ô‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:</div>
            <div class="zone-item">‚Ä¢ ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÄ‡∏•‡πá‡∏Å: <b id="card-sm">-</b> ‡∏°.</div>
            <div class="zone-item">‚Ä¢ ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÉ‡∏´‡∏ç‡πà: <b id="card-lg">-</b> ‡∏°.</div>
            <div class="zone-item">‚Ä¢ ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ: <b id="card-fire">-</b> ‡∏°.</div>
        </div>
    </div>

    <div id="map"></div>

    <div class="search-container">
        <input type="text" id="chemInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ UN No. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£..." oninput="showSuggestions()" autocomplete="off">
        <button onclick="searchChemical()"><i class="fas fa-search"></i></button>
    </div>

    <div id="suggestionsBox" class="suggestions-box"></div>

    <div id="chem-banner" onclick="openDetailCard()">
        <div class="chem-banner-content">
            <i class="fas fa-flask" style="color: #e74c3c; font-size: 1.5rem;"></i>
            <div style="flex: 1;">
                <div id="banner-un" style="font-size: 0.85rem; color: #7f8c8d; font-weight: bold;">UN: -</div>
                <div id="banner-name" style="font-size: 1.1rem; color: #2c3e50; font-weight: bold; line-height: 1.2;">-</div>
            </div>
            <i class="fas fa-chevron-circle-down" style="color: #bdc3c7; font-size: 1.2rem;"></i>
        </div>
    </div>

    <div class="float-btn-group">
        
        <div class="action-btn" onclick="openTutorial()" style="color: #f39c12;" title="‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô">
            <i class="fas fa-question"></i>
        </div>
        
        <div id="scenario-selector">
            <div class="scenario-fab" id="btn-fire" onclick="toggleFire()" title="‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ">
                <i class="fas fa-fire"></i>
            </div>
            <div class="scenario-fab" id="btn-large" onclick="setSpillSize('large')" title="‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏°‡∏≤‡∏Å">
                ‡πÉ‡∏´‡∏ç‡πà
            </div>
            <div class="scenario-fab active-small" id="btn-small" onclick="setSpillSize('small')" title="‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ô‡πâ‡∏≠‡∏¢">
                ‡πÄ‡∏•‡πá‡∏Å
            </div>
        </div>

        <div class="action-btn satellite" onclick="toggleMapLayer()" id="btnLayer">
            <i class="fas fa-satellite"></i>
        </div>
        <div class="action-btn gps-btn" onclick="locateUser()">
            <i class="fas fa-crosshairs"></i>
        </div>
    </div>

    <div id="status-bar">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á: <span id="distDisplay" class="distance-badge">-</span> ‡πÄ‡∏°‡∏ï‡∏£</div>

    <div id="wind-modal-overlay">
        <div class="wind-modal-box">
            <h3><i class="fas fa-wind" style="color:#3498db;"></i> ‡∏•‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ó‡∏¥‡∏®‡πÉ‡∏î?</h3>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà <b>‡∏Å‡πä‡∏≤‡∏ã‡∏û‡∏¥‡∏©‡∏à‡∏∞‡∏•‡∏≠‡∏¢‡πÑ‡∏õ</b><br>(‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ API ‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏¥‡∏®‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)</p>
            
            <div class="speed-display">
                <i class="fas fa-tachometer-alt"></i> ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å API: <b id="apiWindSpeed">0</b> m/s
            </div>

            <div class="compass-grid">
                <button class="dir-btn" data-angle="315" onclick="selectDir(this)"><i class="fas fa-arrow-up" style="transform: rotate(-45deg);"></i><span>‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å<br>‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</span></button>
                <button class="dir-btn" data-angle="0"   onclick="selectDir(this)"><i class="fas fa-arrow-up"></i><span>‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (N)</span></button>
                <button class="dir-btn" data-angle="45"  onclick="selectDir(this)"><i class="fas fa-arrow-up" style="transform: rotate(45deg);"></i><span>‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å<br>‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠</span></button>
                
                <button class="dir-btn" data-angle="270" onclick="selectDir(this)"><i class="fas fa-arrow-up" style="transform: rotate(-90deg);"></i><span>‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å (W)</span></button>
                <div class="compass-center"><i class="fas fa-biohazard" style="color:#e74c3c;"></i></div>
                <button class="dir-btn" data-angle="90"  onclick="selectDir(this)"><i class="fas fa-arrow-up" style="transform: rotate(90deg);"></i><span>‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å (E)</span></button>
                
                <button class="dir-btn" data-angle="225" onclick="selectDir(this)"><i class="fas fa-arrow-up" style="transform: rotate(-135deg);"></i><span>‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å<br>‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÉ‡∏ï‡πâ</span></button>
                <button class="dir-btn" data-angle="180" onclick="selectDir(this)"><i class="fas fa-arrow-up" style="transform: rotate(180deg);"></i><span>‡πÉ‡∏ï‡πâ (S)</span></button>
                <button class="dir-btn" data-angle="135" onclick="selectDir(this)"><i class="fas fa-arrow-up" style="transform: rotate(135deg);"></i><span>‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å<br>‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÉ‡∏ï‡πâ</span></button>
            </div>

            <button class="btn-confirm-wind" onclick="confirmWindData()">
                <i class="fas fa-check-circle"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏°
            </button>
        </div>
    </div>

    <script src="db.js"></script>

    <script>
        let map, incidentMarker, userMarker, currentChem = null;
        let spillCircle, fireCircle, windLine, windCenterLine, windArrow, windTextMarker, cpPolygon, cpTextMarker;
        let landmarkLayer;
        
        let osmLayer, satLayer;
        let isSatellite = false;
        
        let spillSize = 'small'; 
        let hasFire = false;     
        
        let currentWindAngle = 0; 
        let currentWindSpeed = 0;
        let tempLatLng = null; 

       function initMap() {
            map = L.map('map', { zoomControl: false }).setView([12.6814, 101.2816], 12); 
            osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
            
            map.on('click', function(e) { 
                document.getElementById('suggestionsBox').style.display = 'none';
                
                // üåü ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏∏‡∏î ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏õ‡∏±‡∏Å‡πÑ‡∏î‡πâ
                if (currentChem && !incidentMarker) {
                    setIncidentLocation(e.latlng); 
                }
            });

            // üåü üåü ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏ï‡∏≠‡∏ô‡∏ã‡∏π‡∏°‡∏≠‡∏≠‡∏Å üåü üåü
            map.on('zoomend', function() {
                if (map.getZoom() < 16) { // ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏ã‡∏π‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 16 (‡∏ã‡∏π‡∏°‡∏≠‡∏≠‡∏Å‡πÑ‡∏Å‡∏•)
                    document.getElementById('map').classList.add('zoom-out-mode');
                } else { // ‡∏ñ‡πâ‡∏≤‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÜ (‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 15)
                    document.getElementById('map').classList.remove('zoom-out-mode');
                }
            });

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏∞‡∏¢‡∏∞‡∏ã‡∏π‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
            if (map.getZoom() < 16) {
                document.getElementById('map').classList.add('zoom-out-mode');
            }
            // üåü üåü ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° üåü üåü
        }
        
        initMap();
        setTimeout(() => { locateUser(); }, 800); 

        function toggleMapLayer() {
            let btnIcon = document.querySelector('#btnLayer i');
            if (isSatellite) { map.removeLayer(satLayer); osmLayer.addTo(map); isSatellite = false; btnIcon.className = "fas fa-satellite"; } 
            else { map.removeLayer(osmLayer); satLayer.addTo(map); isSatellite = true; btnIcon.className = "fas fa-map"; }
        }

        function showSuggestions() {
            let val = document.getElementById('chemInput').value.trim().toUpperCase();
            let box = document.getElementById('suggestionsBox');
            if(val.length < 2) { box.style.display = 'none'; return; }

            let matches = ERG_DATABASE.filter(c => String(c.mtl_id).includes(val) || (c.name && c.name.toUpperCase().includes(val))).slice(0, 15);
            if(matches.length > 0) {
                box.innerHTML = matches.map(m => `<div class="suggestion-item" onclick="selectSuggestion('${m.mtl_id}')"><i class="fas fa-flask"></i> <div><span style="color:#1a73e8; font-weight:bold;">${m.mtl_id}</span> - <span style="color:#555;">${m.name}</span></div></div>`).join('');
                box.style.display = 'block';
            } else {
                box.innerHTML = `<div class="suggestion-item" style="color:#aaa; justify-content:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
                box.style.display = 'block';
            }
        }

        function selectSuggestion(unNo) {
            document.getElementById('chemInput').value = unNo;
            document.getElementById('suggestionsBox').style.display = 'none';
            searchChemical();
        }

        function searchChemical() {
            let val = document.getElementById('chemInput').value.trim().toUpperCase();
            if(!val) return;
            document.getElementById('suggestionsBox').style.display = 'none';

            let found = ERG_DATABASE.find(c => String(c.mtl_id) === val || (c.name && c.name.toUpperCase() === val));
            if(!found) found = ERG_DATABASE.find(c => c.name && c.name.toUpperCase().includes(val));
            
            if (found) {
                currentChem = found;
                document.getElementById('chemInput').blur();
                document.getElementById('banner-un').innerText = `UN: ${currentChem.mtl_id} | Guide: ${currentChem.guide_num || '-'}`;
                document.getElementById('banner-name').innerText = currentChem.name;
                document.getElementById('chem-banner').style.display = 'block';
                
                // ‡πÇ‡∏ä‡∏ß‡πå‡πÅ‡∏ú‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡πÅ‡∏ö‡∏ö Flex Column
                document.getElementById('scenario-selector').style.display = 'flex';
                
                setSpillSize('small');
                if(hasFire) toggleFire();

                if (incidentMarker) setIncidentLocation(incidentMarker.getLatLng());
            } else {
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            }
        }

        function setSpillSize(size) {
            spillSize = size;
            // ‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡πà‡∏ß‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà
            document.getElementById('btn-small').classList.toggle('active-small', size === 'small');
            document.getElementById('btn-large').classList.toggle('active-large', size === 'large');
            updateMapFeatures();
        }

        function toggleFire() {
            hasFire = !hasFire;
            // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ
            document.getElementById('btn-fire').classList.toggle('active-fire', hasFire);
            updateMapFeatures();
        }

        function updateMapFeatures() {
            if(!incidentMarker) return;
            let latlng = incidentMarker.getLatLng();
            drawSafetyZones(latlng);
            calculateDistance();
            
            if(currentWindSpeed > 0) {
                // üåü ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ currentWindAngle ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ "‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡∏•‡∏°‡∏û‡∏±‡∏î‡πÑ‡∏õ" ‡πÅ‡∏•‡πâ‡∏ß
                let downwindAngle = currentWindAngle; 
                // üåü CP ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏° (‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏•‡∏°)
                let upwindAngle = (currentWindAngle + 180) % 360; 
                let downwindText = getSimpleCompass(downwindAngle); 
                
                drawWindArrowAndText(latlng.lat, latlng.lng, downwindAngle, downwindText, currentWindSpeed);
                drawCommandPostZone(latlng.lat, latlng.lng, upwindAngle);
            }
        }

        function getMaxActiveRadius() {
            if(!currentChem) return 30;
            let rSpill = (spillSize === 'small') ? (currentChem.sm_iso || 30) : (currentChem.lg_iso || 100);
            let rFire = hasFire ? (currentChem.fire_iso || 800) : 0;
            return Math.max(rSpill, rFire);
        }

       function setIncidentLocation(latlng) {
            if (!currentChem) return; 
            
            if (incidentMarker) map.removeLayer(incidentMarker);
            
            // üåü 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            let hazardIcon = L.divIcon({
                className: 'clear-div-icon',
                html: `<div class="incident-icon-wrapper" style="width: 30px; height: 30px;"><i class="fas fa-biohazard"></i></div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            // üåü 2. ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡πÉ‡∏´‡πâ "‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ" (draggable: true)
            incidentMarker = L.marker(latlng, {
                icon: hazardIcon,
                draggable: true // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î
            }).addTo(map)
                .bindTooltip("‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏", { // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
                    permanent: false,
                    direction: 'bottom',
                    offset: [0, 15],
                    className: 'incident-mini-label'
                });
            
            // üåü 3. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ô‡∏¥‡πâ‡∏ß" ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î
            incidentMarker.on('dragend', function(event) {
                let newLatLng = event.target.getLatLng();
                setIncidentLocation(newLatLng); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            });
            
            // ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
            incidentMarker.on('click', openDetailCard);

            drawSafetyZones(latlng);
            calculateDistance();
            
            tempLatLng = latlng; 
            fetchWindAndShowModal(latlng.lat, latlng.lng);
           fetchLandmarks(latlng.lat, latlng.lng);
        }

        function drawSafetyZones(latlng) {
            if (spillCircle) map.removeLayer(spillCircle);
            if (fireCircle) map.removeLayer(fireCircle);
            
            let rSpill = (spillSize === 'small') ? (currentChem.sm_iso || 30) : (currentChem.lg_iso || 100);
            let spillColor = (spillSize === 'small') ? '#e74c3c' : '#f39c12';
            
            spillCircle = L.circle(latlng, { color: spillColor, fillColor: spillColor, fillOpacity: 0.35, weight: 2, radius: rSpill }).addTo(map);

            if (hasFire) {
                let rFire = currentChem.fire_iso || 800;
                fireCircle = L.circle(latlng, { color: '#d35400', fillColor: '#e67e22', fillOpacity: 0.15, weight: 3, dashArray: '10, 10', radius: rFire }).addTo(map);
            }

            let layersToFit = hasFire ? [spillCircle, fireCircle] : [spillCircle];
            map.fitBounds(L.featureGroup(layersToFit).getBounds(), { padding: [30, 30] });
        }

        function getClosestCompassAngle(degree) {
            const angles = [0, 45, 90, 135, 180, 225, 270, 315];
            return angles.reduce((prev, curr) => Math.abs(curr - degree) < Math.abs(prev - degree) ? curr : prev);
        }

        function selectDir(btnElement) {
            document.querySelectorAll('.dir-btn').forEach(b => b.classList.remove('selected'));
            btnElement.classList.add('selected');
            currentWindAngle = parseInt(btnElement.getAttribute('data-angle'));
        }

       async function fetchWindAndShowModal(lat, lng) {
            try {
                document.querySelector('.gps-btn i').className = "fas fa-spinner fa-spin";
                
                let res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=wind_speed_10m,wind_direction_10m&wind_speed_unit=ms`);
                let data = await res.json();
                
                currentWindSpeed = data.current.wind_speed_10m;
                document.getElementById('apiWindSpeed').innerText = currentWindSpeed;
                
                // üåü ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏°‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏ß‡∏Å 180 ‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô "‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡∏•‡∏°‡∏û‡∏±‡∏î‡πÑ‡∏õ"
                let apiWindOrigin = data.current.wind_direction_10m;
                let windDestination = (apiWindOrigin + 180) % 360; 
                
                let closestAngle = getClosestCompassAngle(windDestination);
                let targetBtn = document.querySelector(`.dir-btn[data-angle="${closestAngle}"]`);
                if(targetBtn) selectDir(targetBtn);
                
                document.querySelector('.gps-btn i').className = "fas fa-crosshairs";
                document.getElementById('wind-modal-overlay').style.display = 'flex';

            } catch (e) { 
                console.log("Wind fetch error"); 
                document.querySelector('.gps-btn i').className = "fas fa-crosshairs";
                document.getElementById('apiWindSpeed').innerText = 0;
                let defaultBtn = document.querySelector(`.dir-btn[data-angle="0"]`);
                if(defaultBtn) selectDir(defaultBtn);
                document.getElementById('wind-modal-overlay').style.display = 'flex';
            }
        }

        function confirmWindData() {
            document.getElementById('wind-modal-overlay').style.display = 'none';

            if(tempLatLng) {
                // üåü ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                let downwindAngle = currentWindAngle; 
                let upwindAngle = (currentWindAngle + 180) % 360; 
                let downwindText = getSimpleCompass(downwindAngle); 

                drawWindArrowAndText(tempLatLng.lat, tempLatLng.lng, downwindAngle, downwindText, currentWindSpeed);
                drawCommandPostZone(tempLatLng.lat, tempLatLng.lng, upwindAngle);
            }
        }
      function drawWindArrowAndText(lat, lng, angle, dirText, speed) {
            // ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
            if(windLine) map.removeLayer(windLine);
            if(windCenterLine) map.removeLayer(windCenterLine); // üåü ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ó‡∏¥‡πâ‡∏á (‡πÅ‡∏ï‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏•‡∏ö‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤)
            if(windArrow) map.removeLayer(windArrow);
            if(windTextMarker) map.removeLayer(windTextMarker);

            let maxRadius = getMaxActiveRadius();
            let distanceMeters = Math.max(maxRadius * 1.8, 300); // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏ß‡∏¢‡∏•‡∏°

            // 1. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏ß‡∏¢‡∏™‡∏µ‡∏ü‡πâ‡∏≤ (‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏∏‡πâ‡∏á‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢)
            let points = [[lat, lng]]; 
            for (let i = -15; i <= 15; i += 5) {
                points.push(getDestination(lat, lng, distanceMeters, angle + i));
            }
            windLine = L.polygon(points, {
                color: '#2980b9', fillColor: '#3498db', fillOpacity: 0.25, weight: 2, dashArray: '4, 6'
            }).addTo(map);

            // üåü 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (Flow Arrows) ‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏õ‡πä‡∏∞‡πÜ
            windArrow = L.featureGroup().addTo(map); 
            // ‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏¢‡∏∞ 40%, 65% ‡πÅ‡∏•‡∏∞ 90% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Å‡∏£‡∏ß‡∏¢
            let arrowPositions = [0.40, 0.65, 0.90]; 
            
            arrowPositions.forEach(pos => {
                let posLatLng = getDestination(lat, lng, distanceMeters * pos, angle);
                let arrowIcon = L.marker(posLatLng, {
                    icon: L.divIcon({
                        className: 'clear-div-icon',
                        // ‡∏Ç‡∏¢‡∏≤‡∏¢ font-size ‡πÄ‡∏õ‡πá‡∏ô 28px ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ flex ‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á 30x30px
                        html: `<div style="transform: rotate(${angle}deg); color: #ffffff; font-size: 28px; text-shadow: 0 0 6px rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; width: 30px; height: 30px;"><i class="fas fa-chevron-up"></i></div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15] // üåü ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏¢‡∏∂‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏õ‡πä‡∏∞‡πÜ ‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß‡πÅ‡∏•‡πâ‡∏ß
                    }),
                    interactive: false 
                });
                windArrow.addLayer(arrowIcon);
            });

            // 3. ‡∏õ‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Wind Badge)
            let textLatLng = getDestination(lat, lng, distanceMeters + 40, angle);
            windTextMarker = L.marker(textLatLng, {
                icon: L.divIcon({ 
                    className: 'clear-div-icon', 
                    html: `<div class="wind-badge"><i class="fas fa-wind" style="margin-right:6px; font-size:14px;"></i> ‡∏û‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏¥‡∏® ${dirText} (${speed} m/s)</div>`, 
                    iconSize: [160, 30], 
                    iconAnchor: [80, 15] 
                }),
                interactive: false 
            }).addTo(map);
        }

       function drawCommandPostZone(lat, lng, upwindAngle) {
            if(cpPolygon) map.removeLayer(cpPolygon);
            if(cpTextMarker) map.removeLayer(cpTextMarker);

            let maxRadius = getMaxActiveRadius();
            let startDist = maxRadius + 100; 
            let endDist = Math.max(startDist + 200, 400); 

            // 1. ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà Polygon ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
            let points = [];
            for(let i = -30; i <= 30; i += 10) points.push(getDestination(lat, lng, endDist, upwindAngle + i));
            for(let i = 30; i >= -30; i -= 10) points.push(getDestination(lat, lng, startDist, upwindAngle + i));
            cpPolygon = L.polygon(points, { color: '#27ae60', fillColor: '#2ecc71', fillOpacity: 0.35, weight: 2, dashArray: '5, 5' }).addTo(map);

            // üåü 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà "‡∏ô‡∏≠‡∏Å" ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÑ‡∏Å‡∏•‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏≠‡∏µ‡∏Å 60 ‡πÄ‡∏°‡∏ï‡∏£)
            let cpLabelLoc = getDestination(lat, lng, endDist + 60, upwindAngle);
            
            // üåü 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
            cpTextMarker = L.marker(cpLabelLoc, {
                icon: L.divIcon({ 
                    className: 'cp-text-label', 
                    html: `<i class="fas fa-shield-alt" style="font-size:13px;"></i> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà CP (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)`, 
                    iconSize: [130, 26], // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡∏•‡∏á ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                    iconAnchor: [65, 13] // ‡∏à‡∏∏‡∏î‡∏¢‡∏∂‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
                })
            }).addTo(map);
            
            let layersToFit = hasFire ? [fireCircle, cpPolygon, windLine] : [spillCircle, cpPolygon, windLine];
            map.fitBounds(L.featureGroup(layersToFit).getBounds(), { padding: [50, 50] });
        }

        function getDestination(lat, lng, dist, bearing) {
            let rad = bearing * Math.PI / 180;
            let deltaLat = (dist * Math.cos(rad)) / 111320;
            let deltaLng = (dist * Math.sin(rad)) / (111320 * Math.cos(lat * Math.PI / 180));
            return [lat + deltaLat, lng + deltaLng];
        }

        function getSimpleCompass(deg) {
            const arr = ["N", "NE", "E", "SE", "S", "SW", "W", "NW"];
            return arr[Math.floor((deg / 45) + 0.5) % 8];
        }

        function locateUser() { 
            let btn = document.querySelector('.gps-btn i');
            btn.className = "fas fa-spinner fa-spin";
            map.locate({setView: true, maxZoom: 16}); 
        }

        map.on('locationfound', function(e) {
            let btn = document.querySelector('.gps-btn i');
            btn.className = "fas fa-crosshairs";

            if (userMarker) map.removeLayer(userMarker);
            
            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
            var greenIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41]
            });

            // 2. ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡πâ‡∏≤‡∏¢ "YOU" ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å
            userMarker = L.marker(e.latlng, {icon: greenIcon}).addTo(map)
                .bindTooltip("YOU", { 
                    permanent: true, 
                    direction: 'bottom', // üåü ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
                    className: 'user-location-label',
                    offset: [0, 5]
                });

            calculateDistance();
        });
        
        map.on('locationerror', function(e){ 
            let btn = document.querySelector('.gps-btn i');
            btn.className = "fas fa-crosshairs";
            alert("‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢:\n\n‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ '‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (Allow)' ‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö"); 
        });
        
        function calculateDistance() {
            if (incidentMarker && userMarker) {
                let dist = map.distance(incidentMarker.getLatLng(), userMarker.getLatLng());
                let el = document.getElementById('distDisplay');
                el.innerText = Math.round(dist).toLocaleString();
                
                let maxRadius = getMaxActiveRadius();

                if (dist < maxRadius) { el.style.color = "#ff4d4d"; el.innerHTML += " <span style='font-size:0.8rem;'>(‚õî ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏Å‡∏±‡πâ‡∏ô)</span>"; } 
                else { el.style.color = "#2ecc71"; el.innerHTML += " <span style='font-size:0.8rem;'>(‚úÖ ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢)</span>"; }
            }
        }
        function openDetailCard() {
            if(!currentChem) return;
            document.getElementById('card-name').innerText = currentChem.name;
            document.getElementById('card-un').innerText = `UN: ${currentChem.mtl_id} | Guide: ${currentChem.guide_num}`;
            document.getElementById('card-sm').innerText = currentChem.sm_iso || 30;
            document.getElementById('card-lg').innerText = currentChem.lg_iso || 100;
            document.getElementById('card-fire').innerText = currentChem.fire_iso || 800;
            document.getElementById('detail-card').style.display = 'block';
        }
        function closeDetailCard() { 
            document.getElementById('detail-card').style.display = 'none'; 
        }
        // üåü ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏£‡∏≠‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ü‡∏£‡∏µ‡∏î‡πâ‡∏ß‡∏¢ Overpass API)
        async function fetchLandmarks(lat, lng) {
            if (!landmarkLayer) {
                landmarkLayer = L.layerGroup().addTo(map); // ‡∏™‡∏£‡πâ‡∏≤‡∏á Layer ‡πÑ‡∏ß‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏°‡∏∏‡∏î
            }
            landmarkLayer.clearLayers(); // ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏≤‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏∏‡∏î
            
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ 1500 ‡πÄ‡∏°‡∏ï‡∏£ (1.5 ‡∏Å‡∏°.)
            let radius = 1500; 
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô, ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ï‡∏≥‡∏£‡∏ß‡∏à, ‡∏ß‡∏±‡∏î, ‡∏ï‡∏•‡∏≤‡∏î/‡∏´‡πâ‡∏≤‡∏á
            let query = `[out:json];(node["amenity"~"school|hospital|police|place_of_worship"](around:${radius},${lat},${lng});node["shop"~"supermarket|mall|convenience"](around:${radius},${lat},${lng}););out;`;
            let url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

            try {
                let response = await fetch(url);
                let data = await response.json();

                data.elements.forEach(el => {
                    let name = el.tags['name:th'] || el.tags.name; // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
                    if (!name) return; 

                    let iconClass = "fas fa-map-marker-alt";
                    let color = "#34495e";

                    // ‡πÅ‡∏¢‡∏Å‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                    if (el.tags.amenity === 'school') { iconClass = "fas fa-school"; color = "#e67e22"; } // ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏™‡∏µ‡∏™‡πâ‡∏°
                    else if (el.tags.amenity === 'hospital' || el.tags.amenity === 'clinic') { iconClass = "fas fa-hospital"; color = "#e74c3c"; } // ‡∏£‡∏û. ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                    else if (el.tags.amenity === 'place_of_worship') { iconClass = "fas fa-vihara"; color = "#f1c40f"; } // ‡∏ß‡∏±‡∏î ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á
                    else if (el.tags.amenity === 'police') { iconClass = "fas fa-shield-alt"; color = "#2980b9"; } // ‡∏ï‡∏≥‡∏£‡∏ß‡∏à ‡∏™‡∏µ‡∏ü‡πâ‡∏≤
                    else if (el.tags.shop) { iconClass = "fas fa-shopping-cart"; color = "#27ae60"; } // ‡∏´‡πâ‡∏≤‡∏á/‡∏ï‡∏•‡∏≤‡∏î ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß

                    let customIcon = L.divIcon({
                        className: 'clear-div-icon',
                        html: `<div class="landmark-icon" style="border-color:${color}; color:${color}; width:22px; height:22px; font-size:11px;"><i class="${iconClass}"></i></div>`,
                        iconSize: [22, 22],
                        iconAnchor: [11, 11]
                    });

                    // ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
                    L.marker([el.lat, el.lon], {icon: customIcon})
                        .bindTooltip(`${name}`, {
                            permanent: true,    // üåü ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
                            direction: 'right', // üåü ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ä‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô
                            offset: [10, 0],
                            className: 'landmark-label' // üåü ‡πÉ‡∏ä‡πâ CSS ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô
                        })
                        .addTo(landmarkLayer);
                });
            } catch (error) {
                console.log("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÑ‡∏î‡πâ", error);
            }
        }
        // -------------------------------------------
        // ‡∏£‡∏∞‡∏ö‡∏ö Tutorial & Onboarding (‡∏à‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
        // -------------------------------------------
        function openTutorial() {
            // ‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ö‡∏ö flex ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
            document.getElementById('tutorial-overlay').style.display = 'flex';
        }

        function closeTutorial() {
            // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
            document.getElementById('tutorial-overlay').style.display = 'none';
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Local Storage) ‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ "‡πÄ‡∏Ñ‡∏¢‡∏î‡∏π‡πÅ‡∏•‡πâ‡∏ß"
            localStorage.setItem('hazmat_tutorial_seen', 'true');
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
        window.addEventListener('load', () => {
            let hasSeenTutorial = localStorage.getItem('hazmat_tutorial_seen');
            if (!hasSeenTutorial) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏π (‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏•‡∏¢
                openTutorial();
            }
        });
        // -------------------------------------------
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô PWA Service Worker
        // -------------------------------------------
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πâ‡∏≤:', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker ‡∏û‡∏±‡∏á ‡πÇ‡∏Ñ‡πâ‡∏î‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:', err);
                    });
            });
        }
    </script>
</body>
</html>

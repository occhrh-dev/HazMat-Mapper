<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HazMat Mapper (Pro + Wind)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Sarabun', sans-serif; overflow: hidden; background: #e5e5e5; }
        
        #map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; z-index: 1; }

        /* üîç ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏•‡∏≠‡∏¢ */
        .search-container {
            position: absolute; top: 15px; left: 15px; right: 15px; z-index: 1000;
            display: flex; background: white; border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 5px 10px;
            align-items: center;
        }
        .search-container input {
            flex: 1; border: none; outline: none; padding: 10px 5px 10px 10px;
            font-size: 1rem; border-radius: 30px; font-family: 'Sarabun', sans-serif;
        }
        .search-container button {
            background: #1a73e8; color: white; border: none; border-radius: 50%;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 2px 5px rgba(26,115,232,0.4);
        }

        /* üîΩ Dropdown */
        .suggestions-box {
            display: none; position: absolute; top: 65px; left: 20px; right: 20px; z-index: 999;
            background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-height: 250px; overflow-y: auto;
        }
        .suggestion-item {
            padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 0.95rem;
            cursor: pointer; display: flex; align-items: flex-start; gap: 10px;
        }

        /* üìã ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ */
        #chem-info {
            display: none; position: absolute; top: 75px; left: 15px; right: 15px; z-index: 1000;
            background: white; padding: 15px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-left: 5px solid #ff9800;
            animation: slideDown 0.3s ease-out; max-height: 60vh; overflow-y: auto;
        }
        .close-btn { position: absolute; top: 10px; right: 15px; color: #999; font-size: 1.2rem; cursor: pointer; padding: 5px; }
        
        /* üìñ ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (Legend) */
        #map-legend {
            position: absolute; bottom: 85px; left: 15px; z-index: 1000;
            background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 8px;
            font-size: 0.8rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); line-height: 1.6;
            backdrop-filter: blur(5px);
        }

        /* üìç ‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á */
        .float-btn-group {
            position: absolute; bottom: 85px; right: 15px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .action-btn {
            background: white; border: 2px solid #ddd; border-radius: 50%;
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; color: #1a73e8; font-size: 1.1rem;
        }
        .action-btn.satellite { color: #27ae60; }

        /* üìè ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î */
        #status-bar {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(44, 62, 80, 0.95); backdrop-filter: blur(5px); color: white;
            padding: 15px 10px; text-align: center; font-size: 0.95rem;
            border-top-left-radius: 15px; border-top-right-radius: 15px;
        }
        .distance-badge { font-size: 1.3rem; font-weight: bold; color: #f1c40f; }

        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="search-container">
        <input type="text" id="chemInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ UN No. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£..." oninput="showSuggestions()" autocomplete="off">
        <button onclick="searchChemical()"><i class="fas fa-search"></i></button>
    </div>

    <div id="suggestionsBox" class="suggestions-box"></div>

    <div id="chem-info">
        <i class="fas fa-times close-btn" onclick="closeInfo()"></i>
        <div id="chem-info-content"></div>
    </div>

    <div id="map-legend">
        <b>üìç ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (‡πÇ‡∏ã‡∏ô‡∏†‡∏±‡∏¢)</b><br>
        <div style="color:#c0392b;"><i class="fas fa-circle"></i> ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÄ‡∏•‡πá‡∏Å (‡∏Å‡∏±‡πâ‡∏ô‡πÄ‡∏Ç‡∏ï)</div>
        <div style="color:#f39c12;"><i class="fas fa-circle"></i> ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÉ‡∏´‡∏ç‡πà (‡πÄ‡∏ù‡πâ‡∏≤‡∏£‡∏∞‡∏ß‡∏±‡∏á)</div>
        <div style="color:#8e44ad;"><i class="fas fa-long-arrow-alt-up"></i> ‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏©‡∏à‡∏∞‡∏•‡∏≠‡∏¢‡πÑ‡∏õ</div>
    </div>

    <div class="float-btn-group">
        <div class="action-btn satellite" onclick="toggleMapLayer()" id="btnLayer"><i class="fas fa-satellite"></i></div>
        <div class="action-btn gps-btn" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>
    </div>

    <div id="status-bar">‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á: <span id="distDisplay" class="distance-badge">-</span> ‡πÄ‡∏°‡∏ï‡∏£</div>

    <script src="db.js"></script>

    <script>
        let map, incidentMarker, userMarker, dangerCircle1, dangerCircle2, windLine, currentChem = null;
        let osmLayer, satLayer;
        let isSatellite = false;

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([12.6814, 101.2816], 12); 
            osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
            satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
            
            map.on('click', function(e) { 
                document.getElementById('suggestionsBox').style.display = 'none';
                setIncidentLocation(e.latlng); 
            });
        }
        initMap();

        function toggleMapLayer() {
            let btnIcon = document.querySelector('#btnLayer i');
            if (isSatellite) {
                map.removeLayer(satLayer); osmLayer.addTo(map);
                isSatellite = false; btnIcon.className = "fas fa-satellite";
            } else {
                map.removeLayer(osmLayer); satLayer.addTo(map);
                isSatellite = true; btnIcon.className = "fas fa-map";
            }
        }

        function showSuggestions() {
            let val = document.getElementById('chemInput').value.trim().toUpperCase();
            let box = document.getElementById('suggestionsBox');
            
            if(val.length < 2) { box.style.display = 'none'; return; }

            let matches = ERG_DATABASE.filter(c => 
                String(c.mtl_id).includes(val) || (c.name && c.name.toUpperCase().includes(val))
            ).slice(0, 15);

            if(matches.length > 0) {
                box.innerHTML = matches.map(m => {
                    let safeName = m.name ? m.name.replace(/'/g, "\\'") : '';
                    return `<div class="suggestion-item" onclick="selectSuggestion('${m.mtl_id}')">
                        <i class="fas fa-flask"></i>
                        <div><span style="color:#1a73e8; font-weight:bold;">${m.mtl_id}</span> - <span style="color:#555;">${m.name}</span></div>
                    </div>`
                }).join('');
                box.style.display = 'block';
            } else {
                box.innerHTML = `<div class="suggestion-item" style="color:#aaa; justify-content:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
                box.style.display = 'block';
            }
        }

        function selectSuggestion(unNo) {
            document.getElementById('chemInput').value = unNo;
            document.getElementById('suggestionsBox').style.display = 'none';
            searchChemical();
        }

        function searchChemical() {
            let val = document.getElementById('chemInput').value.trim().toUpperCase();
            if(!val) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            document.getElementById('suggestionsBox').style.display = 'none';

            let found = ERG_DATABASE.find(c => String(c.mtl_id) === val || (c.name && c.name.toUpperCase() === val));
            if(!found) found = ERG_DATABASE.find(c => c.name && c.name.toUpperCase().includes(val));

            let infoBox = document.getElementById('chem-info');
            let content = document.getElementById('chem-info-content');
            
            if (found) {
                currentChem = found;
                infoBox.style.display = 'block';
                content.innerHTML = `
                    <div style="color:#e65100; font-weight:bold; font-size:1.1rem; margin-bottom:5px; line-height:1.2;">
                        <i class="fas fa-biohazard"></i> ${found.name}
                    </div>
                    <div style="font-size:0.9rem; color:#555; margin-bottom:8px;">
                        <b>UN:</b> ${found.mtl_id} | <b>Guide:</b> ${found.guide_num}
                    </div>
                    <div style="background:#fff3e0; padding:8px; border-radius:8px; font-size:0.85rem; color:#d84315;">
                        <b>üî¥ ‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏Å‡∏±‡πâ‡∏ô‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô:</b><br>
                        ‚Ä¢ ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÄ‡∏•‡πá‡∏Å: <b>${found.sm_iso || 30}</b> ‡∏°.<br>
                        ‚Ä¢ ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏´‡∏•‡πÉ‡∏´‡∏ç‡πà: <b>${found.lg_iso || 100}</b> ‡∏°.<br>
                        ‚Ä¢ ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏ü‡πÑ‡∏´‡∏°‡πâ: <b>${found.fire_iso || 800}</b> ‡∏°.
                    </div>
                    
                    <div id="wind-data">
                        <div style="margin-top:10px; font-size:0.8rem; color:#888; text-align:center;">
                            <i class="fas fa-hand-pointer"></i> ‡πÅ‡∏ï‡∏∞‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏ ‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏°
                        </div>
                    </div>
                `;
                
                document.getElementById('chemInput').blur();
                if (incidentMarker) setIncidentLocation(incidentMarker.getLatLng());

            } else {
                infoBox.style.display = 'none';
                alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)");
            }
        }

        function closeInfo() { document.getElementById('chem-info').style.display = 'none'; }

        function setIncidentLocation(latlng) {
            if (!currentChem) return; 
            
            if (incidentMarker) map.removeLayer(incidentMarker);
            
            var redIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            incidentMarker = L.marker(latlng, {icon: redIcon}).addTo(map)
                .bindPopup(`<b>üî• ‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</b>`).openPopup();
            
            drawSafetyZones(latlng);
            calculateDistance();
            
            // üåü ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• API ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î
            fetchWindAndDraw(latlng.lat, latlng.lng);
            
            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            document.getElementById('chem-info').style.display = 'block';
        }

        function drawSafetyZones(latlng) {
            if (dangerCircle1) map.removeLayer(dangerCircle1);
            if (dangerCircle2) map.removeLayer(dangerCircle2);
            
            let rSmall = currentChem.sm_iso || 30;
            let rLarge = currentChem.lg_iso || 100;

            dangerCircle1 = L.circle(latlng, { color: '#c0392b', fillColor: '#e74c3c', fillOpacity: 0.4, radius: rSmall }).addTo(map);
            dangerCircle2 = L.circle(latlng, { color: '#f39c12', fillColor: '#f1c40f', fillOpacity: 0.15, radius: rLarge }).addTo(map);
            
            map.fitBounds(dangerCircle2.getBounds(), { padding: [50, 50] });
        }

        // ==========================================
        // üí® ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á API ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡∏∞‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏°
        // ==========================================
        async function fetchWindAndDraw(lat, lng) {
            let windBox = document.getElementById('wind-data');
            windBox.innerHTML = `<div style="margin-top:10px; font-size:0.8rem; color:#1a73e8; text-align:center;">
                                    <i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®...
                                 </div>`;
            try {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Open-Meteo API (‡∏ü‡∏£‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏¢‡πå)
                let res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=wind_speed_10m,wind_direction_10m`);
                let data = await res.json();
                let windSpeed = data.current.wind_speed_10m; 
                let windDir = data.current.wind_direction_10m; // ‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡∏•‡∏° "‡∏û‡∏±‡∏î‡∏°‡∏≤" (‡∏≠‡∏á‡∏®‡∏≤)

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ó‡∏¥‡∏®‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏•‡∏° (Upwind) ‡πÅ‡∏•‡∏∞‡∏ó‡∏¥‡∏®‡πÉ‡∏ï‡πâ‡∏•‡∏° (Downwind)
                let upwindDir = getSimpleCompass(windDir); 
                let downwindAngle = (windDir + 180) % 360; // ‡∏ö‡∏ß‡∏Å‡πÑ‡∏õ 180 ‡∏≠‡∏á‡∏®‡∏≤ ‡∏Ñ‡∏∑‡∏≠‡∏ù‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏≠‡∏¢‡πÑ‡∏õ
                let downwindDir = getSimpleCompass(downwindAngle); 

                // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏©‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                drawPlumeLine(lat, lng, downwindAngle);

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á
                windBox.innerHTML = `
                    <hr style="margin:10px 0; border:0; border-top:1px dashed #ccc;">
                    <div style="font-size:0.9rem; color:#2c3e50; background:#f8f9fa; padding:10px; border-radius:8px; border:1px solid #ddd;">
                        <b><i class="fas fa-wind" style="color:#3498db;"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏° ‡∏ì ‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</b><br>
                        ‚Ä¢ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏•‡∏°: <b>${windSpeed}</b> km/h<br>
                        ‚Ä¢ ‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏©‡∏à‡∏∞‡∏•‡∏≠‡∏¢‡πÑ‡∏õ: <b style="color:#8e44ad;">${downwindDir}</b><br>
                        <div style="margin-top:8px; padding:6px; background:#e8f5e9; border:1px solid #2ecc71; border-radius:4px; color:#1b5e20;">
                            <b>üìç ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á Command Post:</b><br>
                            ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏≤‡∏á‡∏ó‡∏¥‡∏® <b>${upwindDir}</b> (‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏•‡∏°)
                        </div>
                    </div>
                `;
            } catch (e) {
                windBox.innerHTML = `<div style="margin-top:10px; font-size:0.8rem; color:#e74c3c; text-align:center;">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏°‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï)</div>`;
            }
        }

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏á‡∏®‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏¥‡∏® (N, NE, E...) ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
        function getSimpleCompass(deg) {
            const val = Math.floor((deg / 45) + 0.5);
            const arr = ["‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (N)", "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (NE)", "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å (E)", "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÉ‡∏ï‡πâ (SE)", "‡πÉ‡∏ï‡πâ (S)", "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÉ‡∏ï‡πâ (SW)", "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å (W)", "‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å‡πÄ‡∏â‡∏µ‡∏¢‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ (NW)"];
            return arr[(val % 8)];
        }

        // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á ‡∏ö‡∏≠‡∏Å‡∏ó‡∏¥‡∏®‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏©‡∏à‡∏∞‡∏•‡∏≠‡∏¢‡πÑ‡∏õ
        function drawPlumeLine(lat, lng, downwindAngle) {
            if(windLine) map.removeLayer(windLine);

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏™‡πâ‡∏ô (‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏á‡∏Å‡∏•‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á 2 ‡πÄ‡∏ó‡πà‡∏≤ ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î)
            let rLarge = currentChem.iso_large || 500;
            let distanceMeters = Math.max(rLarge * 2, 1000); 

            // ‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏•‡∏°)
            let rad = downwindAngle * Math.PI / 180;
            let deltaLat = (distanceMeters * Math.cos(rad)) / 111320;
            let deltaLng = (distanceMeters * Math.sin(rad)) / (111320 * Math.cos(lat * Math.PI / 180));
            let endLatLng = [lat + deltaLat, lng + deltaLng];

            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô
            windLine = L.polyline([[lat, lng], endLatLng], {
                color: '#8e44ad',  // ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á
                weight: 5, 
                dashArray: '10, 10', // ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞
                opacity: 0.8
            }).addTo(map);
        }

        // ==========================================
        // üìç ‡∏£‡∏∞‡∏ö‡∏ö GPS ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        // ==========================================
        function locateUser() { 
            let btn = document.querySelector('.gps-btn i');
            btn.className = "fas fa-spinner fa-spin";
            map.locate({setView: true, maxZoom: 16}); 
        }

        map.on('locationfound', function(e) {
            let btn = document.querySelector('.gps-btn i');
            btn.className = "fas fa-crosshairs";

            if (userMarker) map.removeLayer(userMarker);
            
            var blueIcon = new L.Icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            userMarker = L.marker(e.latlng, {icon: blueIcon}).addTo(map).bindPopup("üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì").openPopup();
            calculateDistance();
        });

        map.on('locationerror', function(e){ 
            let btn = document.querySelector('.gps-btn i');
            btn.className = "fas fa-crosshairs";
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡∏ó‡∏µ‡πà‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö"); 
        });
        
        function calculateDistance() {
            if (incidentMarker && userMarker) {
                let dist = map.distance(incidentMarker.getLatLng(), userMarker.getLatLng());
                let el = document.getElementById('distDisplay');
                el.innerText = Math.round(dist).toLocaleString();
                
                let rSmall = currentChem.sm_iso || 30;
                let rLarge = currentChem.lg_iso || 100;

                if (dist < rSmall) {
                    el.style.color = "#ff4d4d"; el.innerHTML += " <br><span style='font-size:0.8rem;'>(‚õî ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏Å‡∏±‡πâ‡∏ô)</span>";
                } else if (dist < rLarge) {
                    el.style.color = "#f39c12"; el.innerHTML += " <br><span style='font-size:0.8rem;'>(‚ö†Ô∏è ‡∏£‡∏∞‡∏ß‡∏±‡∏á! ‡∏≠‡∏≤‡∏à‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö)</span>";
                } else {
                    el.style.color = "#2ecc71"; el.innerHTML += " <br><span style='font-size:0.8rem;'>(‚úÖ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢)</span>";
                }
            }
        }
    </script>
</body>
</html>
